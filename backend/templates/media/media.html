{% extends 'base/base.html' %}
{% load static %}
{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <header>
        <div class="grid-header">
            <div class="title">
                <h1>Medien</h1>
            </div>
        </div>
    </header>
    <div class="custom-main">
        <div class="sidebar">
            <div class="logo">
                <img src="{% static 'images/brigada.png' %}" alt='brigada'/>
            </div>
            <div class="navigation">
                <a href="{% url 'home' %}" class="section">
                    <div class="grid-section not-current">
                        <div class="icon">
                            <img src="{% static 'svgs/home_filled.svg' %}" alt='home'/>
                        </div>
                        <div class="text">
                            Home
                        </div>
                    </div>
                </a>
                <a href="{% url 'home' %}" class="section">
                    <div class="grid-section not-current">
                        <div class="icon">
                            <img src="{% static 'svgs/notification_filled.svg' %}" alt='home'/>
                        </div>
                        <div class="text">
                            Benachrichtigung
                        </div>
                    </div>
                </a>
                <a href="{% url 'home' %}" class="section">
                    <div class="grid-section not-current">
                        <div class="icon">
                            <img src="{% static 'svgs/log_filled.svg' %}" alt='home'/>
                        </div>
                        <div class="text">
                            Systemprotokolle
                        </div>
                    </div>
                </a>
                <a href="{% url 'home' %}" class="section">
                    <div class="grid-section not-current">
                        <div class="icon">
                            <img src="{% static 'svgs/group_filled.svg' %}" alt='home'/>
                        </div>
                        <div class="text">
                            Benutzer
                        </div>
                    </div>
                </a>
                <a href="{% url 'home' %}" class="section">
                    <div class="grid-section not-current">
                        <div class="icon">
                            <img src="{% static 'svgs/help_filled.svg' %}" alt='home'/>
                        </div>
                        <div class="text">
                            Hilfe
                        </div>
                    </div>
                </a>
            </div>
            <div class="rest-sidebar">
                <a href="{% url 'logout' %}">
                    Abmelden
                </a>
            </div>
        </div>
        <div class="media">
            <div class="grid-media">
                <div class="section">
                    <div>
                        Startseite
                    </div>
                </div>
                <div class="section">
                    <div>
                        Suche
                    </div>
                </div>
                <div class="section">
                    <div>
                        Abonniert
                    </div>
                </div>
                <div class="section">
                    <div>
                        Abonnenten
                    </div>
                </div>
            </div>
        </div>
        <div class="content">
            <div class="feed-container">
                <div class="feeds">
                    {% for feed in feeds %}
                        <div class="feed">
                            <div class="feed-user">
                                <div class="feed-profile">
                                    <img src="{% static 'svgs/profile_filled.svg' %}"/>
                                </div>
                                <div class="feed-name">
                                    <p>{{ feed.author.first_name }} {{ feed.author.last_name }}</p>
                                    {% if feed.author.verified %}
                                        <img src="{% static 'images/verified_filled.svg' %}" alt="verified"/>

                                    {% endif %}
                                </div>
                                <div class="feed-username">
                                    <p>@{{ feed.author.username }}</p>
                                </div>
                            </div>
                            <div class="feed-description">
                                <p>{{ feed.description }}</p>
                            </div>
                            <div class="feed-image">
                                {% if feed.image %}
                                    <img src="{{ feed.get_image_url }}" alt="{{ feed.description }}">
                                {% endif %}
                            </div>
                            <div class="feed-buttons">
                                <div class="button-like">
                                    {% if feed.id not in unlike_flag %}
                                        <button class="unlike-btn" data-feed-id="{{ feed.id }}">
                                            <img class="like" src="{% static 'svgs/heart_filled.svg' %}"/>
                                        </button>
                                    {% endif %}
                                    {% if feed.id in unlike_flag %}
                                        <button class="like-btn" data-feed-id="{{ feed.id }}">
                                            <img class="unlike" src="{% static 'svgs/heart_unfilled.svg' %}"/>
                                        </button>
                                    {% endif %}
                                </div>
                                <div class="feed-like">
                                        <p class="likes-count">{{ feed.likes.count }}</p>
                                </div>

                                <script>
                                    $(document).ready(function () {
                                        $(".like-btn").click(function (e) {
                                            e.preventDefault();
                                            var $this = $(this);
                                            if ($this.prop("disabled")) {
                                                // Der Button ist bereits deaktiviert, die Anfrage wird gerade bearbeitet
                                                return;
                                            }
                                            $this.prop("disabled", true); // Button deaktivieren, um mehrfache Klicks zu verhindern
                                            var feedId = $this.data("feed-id");
                                            var url = "/feeds/" + feedId + "/like";
                                            var heartImage = $this.find("img");
                                            $.ajax({
                                                url: url,
                                                type: "POST",
                                                data: {
                                                    csrfmiddlewaretoken: "{{ csrf_token }}"
                                                },
                                                success: function (data) {
                                                    var likesCount = parseInt($(`.likes-count[data-feed-id='${feedId}']`).text());
                                                    $(".likes-count[data-feed-id='" + feedId + "']").text(likesCount + 1);
                                                    heartImage.attr("src", "{% static 'svgs/heart_unfilled.svg' %}");
                                                    $this.hide();
                                                    $(".unlike-btn[data-feed-id='" + feedId + "']").show();
                                                },
                                                complete: function () {
                                                    $this.prop("disabled", false); // Button aktivieren, wenn die Anfrage abgeschlossen ist
                                                }
                                            });
                                        });

                                        $(".unlike-btn").click(function (e) {
                                            e.preventDefault();
                                            var $this = $(this);
                                            if ($this.prop("disabled")) {
                                                // Der Button ist bereits deaktiviert, die Anfrage wird gerade bearbeitet
                                                return;
                                            }
                                            $this.prop("disabled", true); // Button deaktivieren, um mehrfache Klicks zu verhindern
                                            var feedId = $this.data("feed-id");
                                            var url = "/feeds/" + feedId + "/unlike";
                                            var heartImage = $this.find("img");
                                            $.ajax({
                                                url: url,
                                                type: "POST",
                                                data: {
                                                    csrfmiddlewaretoken: "{{ csrf_token }}"
                                                },
                                                success: function (data) {
                                                    var likesCount = parseInt($(`.likes-count[data-feed-id='${feedId}']`).text());
                                                    $(".likes-count[data-feed-id='" + feedId + "']").text(likesCount - 1);
                                                    heartImage.attr("src", "/static/svgs/heart_unfilled.svg");
                                                    $this.hide();
                                                    $(".like-btn[data-feed-id='" + feedId + "']").show();
                                                },
                                                complete: function () {
                                                    $this.prop("disabled", false); // Button aktivieren, wenn die Anfrage abgeschlossen ist
                                                }
                                            });
                                        });
                                    });
                                </script>

                                <div class="button-commentary">
                                    <img class="unlike" src="{% static 'svgs/commentary_unfilled.svg' %}"/>
                                </div>
                                <div class="feed-commentary">
                                    {% if feed.commentaries.count < 1 %}
                                        <p></p>
                                    {% else %}
                                        <p>{{ feed.commentaries.count }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="ad">
            <div class="text">
                <div class="swiss-made">
                    <p>Swiss Made</p>
                </div>
                <div class="kiidle">
                    <p class="blue">K</p>
                    <p class="red">i</p>
                    <p class="gold">i</p>
                    <p class="blue">d</p>
                    <p class="green">l</p>
                    <p class="red">e</p>
                </div>
            </div>
            <div class="flag">
                <img src="{% static 'images/switzerland.png' %}" alt='brigada'/>
            </div>
        </div>
    </footer>
{% endblock %}